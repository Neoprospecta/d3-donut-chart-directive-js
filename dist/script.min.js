var DEFAULT_SIZE=300,thickness=40,duration=750,toolTipDiv=d3.select(".donut-chart").append("div").attr("class","toolTip"),circleTipDiv=d3.select(".donut-chart").append("div").attr("class","circleTip");d3.selectAll(".donut-chart").append("svg").attr("class","pie").each(function(t,e){var a=d3.select(this),r=a._groups[0][0].parentElement,l=r.getAttribute("width")?r.getAttribute("width"):DEFAULT_SIZE,n=r.getAttribute("height")?r.getAttribute("height"):DEFAULT_SIZE,i=Math.min(l,n)/2;a.style("width",l),a.style("height",n),a.style("padding","10px 45px"),a.style("overflow","visible");var o=a.append("g").attr("transform","translate("+l/2+","+l/2+")");o.append("g").attr("class","slices"),o.append("g").attr("class","labelName"),o.append("g").attr("class","lines");var s=a.append("g").attr("class","legend").attr("transform","translate(10,"+(parseInt(l)+10)+")").style("font-size","12px"),c=d3.arc().outerRadius(.8*i).innerRadius(.6*i).cornerRadius(3).padAngle(.015),d=d3.arc().outerRadius(.9*i).innerRadius(.9*i),p=r.getAttribute("label")?r.getAttribute("label"):"name",u=r.getAttribute("labelStyle")?r.getAttribute("labelStyle"):"text",g=r.getAttribute("slice")?r.getAttribute("slice"):"value",h=r.getAttribute("tooltip")?r.getAttribute("tooltip"):"circle",y=r.getAttribute("tooltip-msg")?r.getAttribute("tooltip-msg"):"",f=r.getAttribute("legend")?r.getAttribute("legend"):"",v=d3.pie().value(function(t){return t[g]}).sort(null),m=r.getAttribute("colorScheme")?d3.scaleOrdinal(d3[r.getAttribute("colorScheme")]):d3.scaleOrdinal(d3.schemeCategory10);function A(t){return t.startAngle+(t.endAngle-t.startAngle)/2}function b(t,e){var a=t.match(/{{(.*)}}/);return a?(a=a.pop(),t.replace(/{{(\w+)}}/g,e.data[a])):t}d3.json(r.getAttribute("url"),function(t){var e=t;o.select(".slices").datum(e).selectAll("path").data(v).enter().append("path").style("opacity",.9).attr("d",c).attr("fill",function(t,e){return m(e)}).attr("data-legend",function(t){return t.data[f]}).attr("data",function(t){return t.data.percentage=(t.endAngle-t.startAngle)/(2*Math.PI)*100,JSON.stringify(t.data)}).on("mousemove",function(t){var e=d3.select(this),a=JSON.parse(e.attr("data"));"popover"===h?(toolTipDiv.transition().duration(150).style("opacity",1),toolTipDiv.style("left",d3.event.pageX+10+"px"),toolTipDiv.style("top",d3.event.pageY-25+"px"),toolTipDiv.html(b(y,t))):"percentage"===h&&(toolTipDiv.transition().duration(150).style("opacity",1),toolTipDiv.style("left",d3.event.pageX+10+"px"),toolTipDiv.style("top",d3.event.pageY-25+"px"),toolTipDiv.html(d3.format("0.2f")(a.percentage)+"%"))}).on("mouseover",function(t){d3.select(this).style("cursor","pointer").style("opacity",1)}).on("mouseenter",function(t){"circle"===h&&""!==y&&(a.append("text").attr("transform","translate("+l/2+","+l/2+")").attr("class","toolCircleMsg").attr("dy",-15).html(b(y,t)).style("font-size","1em").style("text-anchor","middle"),a.append("circle").attr("transform","translate("+l/2+","+l/2+")").attr("class","toolCircle").attr("r",.55*i).attr("fill",m(this._current)).style("fill-opacity",.35))}).on("mouseout",function(t){d3.select(this).style("cursor","none").style("fill",m(this._current)).style("opacity",.9),toolTipDiv.transition().duration(300).style("opacity",0),d3.selectAll(".toolCircle").remove(),d3.selectAll(".toolCircleMsg").remove()}).each(function(t,e){this._current=e});"none"!==u&&(o.select(".labelName").datum(e).selectAll("text").data(v).enter().append("text").attr("dy",".35em").html(function(t){return"percentage"===u?d3.format("0.2f")(t.data.percentage)+"%":"text"===u?t.data[p]:void 0}).attr("transform",function(t){var e=d.centroid(t);return e[0]=.95*i*(A(t)<Math.PI?1:-1),"translate("+e+")"}).style("text-anchor",function(t){return A(t)<Math.PI?"start":"end"}),o.select(".lines").datum(e).selectAll("polyline").data(v).enter().append("polyline").attr("points",function(t){var e=d.centroid(t);return e[0]=.95*i*(A(t)<Math.PI?1:-1),[c.centroid(t),d.centroid(t),e]})),""!==f&&(a.select(".legend").call(d3.legend),s.style("font-size","20px").attr("data-style-padding",10).call(d3.legend))})});
d3.legend=function(e){return e.each(function(){var e=d3.select(this),l={},t=d3.select(e.property("nearestViewportElement")),n=e.attr("data-style-padding")||5,a=e.selectAll(".legend-box").data([!0]);a.enter().append("rect").style("fill","rgba(255, 255, 255, 0)").classed("legend-box",!0),e.selectAll(".legend-items").data(["g"]).enter().append("g").attr("class","legend-items");var r=e.selectAll(".legend-items");t.selectAll("[data-legend]").each(function(e){var t=d3.select(this);l[t.attr("data-legend")]={pos:t.attr("data-legend-pos")||this.getBBox().y,color:null!=t.attr("data-legend-color")?t.attr("data-legend-color"):"none"!=t.style("fill")?t.style("fill"):t.style("stroke")}}),l=d3.entries(l).sort(function(e,t){return e.value.pos-t.value.pos}),r.selectAll("text").data(l,function(e){return e.key}).call(function(e){e.enter().append("text")}).call(function(e){e.exit().remove()}).attr("y",function(e,t){return t+"em"}).attr("x","1em").text(function(e){return e.key}),r.selectAll("circle").data(l,function(e){return e.key}).call(function(e){e.enter().append("circle")}).call(function(e){e.exit().remove()}).attr("cy",function(e,t){return t-.25+"em"}).attr("cx",0).attr("r","0.4em").style("fill",function(e){return e.value.color});var c=r.node().getBBox();a.attr("x",c.x-n).attr("y",c.y-n).attr("height",c.height+2*n).attr("width",c.width+2*n)}),e};